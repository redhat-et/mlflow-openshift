# Setup Guide

You can follow these instructions to deploy and setup MLFlow on OpenShift.

## Pre-Requisites

To start you will need the following:
* **OpenShift cluster** with namespace available and sufficient privileges/memory to deploy
* **PostgreSQL database** - for storing MLFlow metadata
* **S3 bucket** - for storing the MLFLow artifacts such as model training files (CSVs)

***Note***: If you don't have s3 configured, by default MLFlow will log the artifacts to its pod memory. The con of this is that the artifacts will only persist for as long as the pod is "alive". Hence, we recommend having a long term solution such as s3.

## Instructions

### MLFlow Deployment

We will be deploying MLFlow with an [OAuth proxy](https://github.com/openshift/oauth-proxy) i.e. a reverse proxy that provides authentication with OpenShift via OAuth and Kubernetes service accounts. This will require only users with authenticated accounts to access MLFlow.

**Step 1**: Create a new project in your OpenShift cluster and provide a suitable name. You can either use the web console UI to do this or using the `oc` CLI by running `oc new-project <project-name>`.

<img width="676" alt="Screenshot 2023-02-28 at 10 27 24 AM" src="https://user-images.githubusercontent.com/7343099/221952209-4e8cc300-a224-4ade-b70b-833b26a561e3.png">

**Step 2**: Create a service account by navigating to `User Managment -> ServiceAccounts -> Create Service Account`. You can provide the service account name as `mlflow`. Use [this](https://github.com/redhat-et/mlflow-openshift/blob/main/openshift/mlflow-sa.yaml) service account YAML. Once the service account is created, you will need to provide additional privileges to it so that it can be used by MLFlow to write to the pod (for storing artifats) by running: `oc adm policy add-scc-to-user privileged -z <service-account-name> -n <project-name>`. If you don't have sufficient acces to run this command, reach out to the cluster admin admin request them to run the command.

<img width="1295" alt="Screenshot 2023-02-28 at 10 49 22 AM" src="https://user-images.githubusercontent.com/7343099/221952299-9c4de5ba-20c1-4815-8bda-2a6088a9149f.png">

**Step 3**: We can now create the MLFlow deployment by navigating to `Workloads -> Deployments -> Create Deployment`. Copy and paste the [deployment](https://github.com/redhat-et/mlflow-openshift/blob/main/openshift/mlflow-server-deployment.yaml) file. You will need to edit the following fields in the yaml file:
- In [the spec](https://github.com/redhat-et/mlflow-openshift/blob/main/openshift/mlflow-server-deployment.yaml#L15) **provide the service account name** that you created above in step 3.
- In [the oauth spec](https://github.com/redhat-et/mlflow-openshift/blob/main/openshift/mlflow-server-deployment.yaml#L21) **provide the service account name** that you created above in step 3.
- In [the spec](https://github.com/redhat-et/mlflow-openshift/blob/main/openshift/mlflow-server-deployment.yaml#L71) **provide your PostgreSQL database configurations** (db user, db password, db name, the project/namespace name where it is deployed)

***Note***: We are using the MLflow base image `quay.io/harshad16/mlflow:v0.1.1` (mentioned [here](https://github.com/redhat-et/mlflow-openshift/blob/main/openshift/mlflow-server-deployment.yaml#L61) which has been generated by using [this Dockerfile.](https://github.com/redhat-et/mlflow-openshift/blob/main/openshift/Dockerfile)

Once the necessary fields are edited click on `Create`.

<img width="1277" alt="Screenshot 2023-02-28 at 10 52 39 AM" src="https://user-images.githubusercontent.com/7343099/221952396-6e81c906-574f-4797-9bda-cc6477d9b13f.png">

 **Step 4**: If successful, you will now see a deployment created when you navigate to `Workloads -> Deployments`. You should see the deployment `mlflow-server` created.
 
 <img width="1428" alt="Screenshot 2023-02-28 at 10 53 26 AM" src="https://user-images.githubusercontent.com/7343099/221952510-842da0fd-b4e7-45ac-8f17-6cb89ee8ae76.png"> 
 
 ### MLFlow Service
 
 **Step 1**: We also need to create a service for MLFlow. This can be done using the OpenShift console by navigating to `Networking -> Services -> Create Service`. You can copy and paste [this service yaml](https://github.com/redhat-et/mlflow-openshift/blob/main/openshift/mlflow-server-service.yaml) and then click on `Create`. The service `mlflow-server` will be created.
 
 <img width="1123" alt="Screenshot 2023-02-28 at 11 50 42 AM" src="https://user-images.githubusercontent.com/7343099/221963293-d51f2ef0-e3d2-4fa3-945f-afffa8c5749c.png">
 
 **Step 2**: Once the `mlflow-server` service is created, we can add a route to it i.e generate an HTTPS link which is accessible to interact with MLFlow. To generate a route navigate to `Networking -> Routes -> Create Route -> Edit YAML (top right)`. Copy and paste the YAML as defined [here](https://github.com/redhat-et/mlflow-openshift/blob/main/openshift/mlflow-server-service.yaml).
 
 <img width="1008" alt="Screenshot 2023-03-01 at 2 01 27 PM" src="https://user-images.githubusercontent.com/7343099/222275074-88b69763-023b-48b8-8f21-713614ef8175.png">

You should then be able to see the route created as follows:

<img width="1630" alt="Screenshot 2023-02-28 at 11 59 18 AM" src="https://user-images.githubusercontent.com/7343099/221965205-8953afbc-da65-47df-a7e0-635cad3ebe1c.png">

Click on the link (mentioned under `Location` in the above screenshot) generated to access the MLFlow UI. It will request the user to login:

<img width="773" alt="Screenshot 2023-03-03 at 12 22 04 PM" src="https://user-images.githubusercontent.com/7343099/222821410-fdf14e10-dfb6-485d-9c13-f6b466542b56.png">

 After the user successfully logins in, they will be able to view the MLFlow UI:

<img width="956" alt="Screenshot 2023-03-01 at 2 20 07 PM" src="https://user-images.githubusercontent.com/7343099/222278411-3a25ef3b-c124-4877-a68e-5017f5ab2c29.png">

Congratulations! You are all set to use and explore MLFlow :tada:

